DELIMITER //
CREATE PROCEDURE calculate_CA_marks()

BEGIN
DECLARE done BOOLEAN DEFAULT FALSE;
DECLARE quiz01 DECIMAL(5,2);
DECLARE quiz02 DECIMAL(5,2);
DECLARE quiz03 DECIMAL(5,2);
DECLARE sumOfquiz DECIMAL(5,2);
DECLARE minNum DECIMAL(5,2);
DECLARE CA_10_marks DECIMAL(5,2);



DECLARE mark_code varchar(15);
DECLARE get_course_code varchar(15);
DECLARE get_Student_Id varchar(20);

DECLARE assigment_marks DECIMAL(5,2);
DECLARE mid_theory_marks DECIMAL(5,2);
DECLARE mid_practical_marks DECIMAL(5,2);
DECLARE mark_type enum('Theory','Practical','Both');
DECLARE mid_25_marks DECIMAL(5,2);
DECLARE mid_40_marks DECIMAL(5,2);
	
DECLARE cursor01 CURSOR FOR
	SELECT student_id,course_code,Quiz_01, Quiz_02,Quiz_03, Assessment_01,Mid_Theory,Mid_Practical,Type FROM mark;

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=TRUE;

OPEN cursor01;

read_loop:LOOP
		FETCH cursor01 INTO get_Student_Id , get_course_code,
		quiz01,quiz02,quiz03, assigment_marks,mid_theory_marks,mid_practical_marks,mark_type ;
	IF done THEN
		LEAVE read_loop;
	END IF;

	SET sumOfquiz=quiz01+quiz02+quiz03;
	SET minNum=LEAST(quiz01,quiz02,quiz03);
	SET sumOfquiz=sumOfquiz-minNum;
	SET CA_10_marks=(sumOfquiz/200)*10;

	SET assigment_marks=(assigment_marks/100)*5;
				

			IF mark_type='Theory' THEN 
				SET  mid_25_marks=(mid_theory_marks/100)*25;
				  
			ELSEIF mark_type='Practical' THEN
				SET  mid_25_marks=(mid_practical_marks/100)*25;	
				 
			ELSEIF mark_type='Both' THEN
				SET  mid_25_marks=((mid_theory_marks+mid_practical_marks)/200)*25;
			ELSE 
				SET  mid_25_marks=0;
									
			END IF;	

		SET  mid_40_marks=mid_25_marks+CA_10_marks+assigment_marks;


		UPDATE student_result
		SET  CA_Marks=mid_40_marks
		WHERE student_id=get_Student_Id
		AND course_code=get_course_code;


END LOOP;

CLOSE cursor01;

END//
DELIMITER ;

CALL  calculate_CA_marks();