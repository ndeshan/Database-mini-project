


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Nipuna



DELIMITER //

CREATE PROCEDURE exam_enrollment_all()
BEGIN

    UPDATE exam_enrollment e
    INNER JOIN attendance_summary a 
        ON e.ST_Id = a.ST_Id 
        AND e.Course_code = a.Course_code
    SET e.Attendance_Eligible = 1
    WHERE a.Eligibility = 'Eligible';

        UPDATE exam_enrollment e
    LEFT JOIN attendance_summary a 
        ON e.ST_Id = a.ST_Id 
        AND e.Course_code = a.Course_code
    SET e.Attendance_Eligible = 0
    WHERE a.Eligibility IS NULL OR a.Eligibility != 'Eligible';


    UPDATE exam_enrollment e
    INNER JOIN student_result r 
        ON e.ST_Id = r.student_id 
        AND e.Course_code = r.course_code
    SET e.CA_Eligible = 
        CASE 
            WHEN r.CA_Marks > 20 THEN 1            
            ELSE 0                        
        END;

    UPDATE exam_enrollment e
    LEFT JOIN student_result r 
        ON e.ST_Id = r.student_id 
        AND e.Course_code = r.course_code
    SET e.CA_Eligible = 0
    WHERE r.student_id IS NULL;


   
    UPDATE exam_enrollment e
    SET e.Final_Eligible = 
        CASE 
            WHEN e.Attendance_Eligible = 1 AND e.CA_Eligible = 1 THEN 1
            ELSE 0
        END;
END//

DELIMITER ;

call exam_enrollment_all();






DELIMITER //

CREATE PROCEDURE course_enrollment_new_insert (
    IN p_ST_Id VARCHAR(20),       
    IN p_Course_code VARCHAR(15), 
     IN p_Semester VARCHAR(20))
 
BEGIN
    
    DECLARE attend BOOLEAN DEFAULT 0;
    DECLARE camark BOOLEAN DEFAULT 0;
    DECLARE finalmark BOOLEAN DEFAULT 0;

    DECLARE attend_status VARCHAR(12) DEFAULT '';
    DECLARE ca_score DECIMAL(5,2) DEFAULT NULL;

    SELECT Eligibility INTO attend_status
    FROM attendance_summary
    WHERE ST_Id = p_ST_Id AND Course_code = p_Course_code
    LIMIT 1;

    IF attend_status = 'Eligible' THEN
        SET attend = 1;
    ELSE
        SET attend = 0;  
    END IF;


    SELECT CA_Marks INTO ca_score
    FROM student_result
    WHERE student_id = p_ST_Id AND course_code = p_Course_code
    LIMIT 1;

    IF ca_score IS NOT NULL AND ca_score > 20 THEN
        SET camark = 1; 
    ELSE
        SET camark = 0;  
    END IF;


    
    IF attend = 1 AND camark = 1 THEN
        SET finalmark = 1;
    ELSE
        SET finalmark = 0;  
    END IF;


  
    SET @enroll_id = CONCAT(
        'EEXM_',
        REPLACE(LEFT(p_ST_Id, 10), '/', ''),  
        '_',
        LEFT(p_Course_code, 7)                
    );


    
    INSERT INTO exam_enrollment (
        Enrollment_Id,
        ST_Id,
        Semester,
        Course_code,
        Attendance_Eligible,
        CA_Eligible,
        Final_Eligible
    ) VALUES (
        @enroll_id,
        p_ST_Id,
        p_Semester,
        p_Course_code,
        attend,
        camark,
        finalmark
    );

END //

DELIMITER ;



call course_enrollment_new_insert('tg/2023/0020', 'ICT1222', 'Semester 2');






DELIMITER //

CREATE PROCEDURE getstudentresults(
    IN p_student_id VARCHAR(20)
)
BEGIN
    SELECT
            Result_Id,
             student_id,
    course_code,
             Semester,
            CA_Marks,
             Final_Marks,
             Final_Grade,
             Result_Status,
             SGPA,
           CGPA
         FROM student_result
         WHERE student_id = p_student_id
        ORDER BY course_code;
    
END //

DELIMITER ;

call getstudentresults('tg/2023/0002');







-- meka awilla student_id eka input ekiak widiyata aragena student register wechcha course okkama details ekka pennanawa.e  ayage comfermation ekath ekka.


DELIMITER //

CREATE PROCEDURE getstudentcourses(IN student_id VARCHAR(20))
BEGIN
    SELECT DISTINCT 
        c.Course_code,
        c.Name AS Course_Name,
        c.Type,
        c.Credit,
        c.Theory_Hours,
        c.Practical_Hours,
        c.Year AS Acedemic_year,
        c.Semester,
        c.Department_Offering,
	ce.Official_Confirmation,
	 c.Lec_Name AS Lecturer_name
       
    FROM student_course sc
    JOIN course_unit c ON sc.Course_code = c.Course_code
    join course_enrollment ce ON sc.ST_Id = ce.ST_Id
    WHERE sc.ST_Id = student_id;
END//

DELIMITER ;









-- meka awilla corse code eka input eka widiyata aragena e course ekata adalawa whole batch ekema details tika pennana eka.



DELIMITER //

CREATE PROCEDURE getcoursebatchsummary(IN input_course_code VARCHAR(15))
BEGIN
    SELECT 
        student_id,
        course_code,
        Semester,
        CA_marks,
        Final_Marks,
        Final_Grade,
        Result_Status
    FROM student_result
    WHERE course_code = input_course_code
    ORDER BY student_id;
END//

DELIMITER ;


CALL getcoursebatchsummary('BST1212');




////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Tharupama
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


-- attendance by stid (attendance_by_stid("tg/2024/0001");)
DELIMITER //
CREATE PROCEDURE attendance_by_stid(IN p_stid VARCHAR(20))
    BEGIN
      SELECT
        a.Course_code,
        a.Session_Type,
        SUM(CASE WHEN a.Status = 'Present' THEN 1 ELSE 0 END) AS Present,
        SUM(CASE WHEN a.Status = 'Absent'  THEN 1 ELSE 0 END) AS Absent,
        COUNT(*) AS Total,
      MAX(s.Percentage) AS Percentage,
      MAX(s.Eligibility) AS Eligibility
      FROM attendance AS a
      JOIN attendance_percentage_by_hours AS s ON a.ST_Id = s.ST_Id
        AND a.Course_code = s.Course_code
      WHERE a.ST_Id = p_stid
      GROUP BY a.Course_code, a.Session_Type;
    END //

DELIMITER ;




-- attendance by stid and course id and session type ("tg/2024/0001","ICT1253","t")
DELIMITER //
CREATE PROCEDURE attendance_by_stid_cid_seperate_type(
      IN st_id VARCHAR(20),
      IN c_id VARCHAR(20),
      IN s_type VARCHAR(2)
     )
     BEGIN
    
      DECLARE se_type VARCHAR(20);
    
      IF s_type IN ('t','T') THEN
              SET se_type = 'Theory';
      ELSEIF s_type IN ('p','P') THEN
              SET se_type = 'Practical';
      ELSE
              SELECT 'Invalid input please enter (\'t\',\'T\') or (\'p\',\'P\')' AS MESSAGE;
    
      END IF;
    
      SELECT Session_Date, Week_Number, Session_Type, Status
      FROM attendance
      WHERE ST_Id = st_id
        AND Course_code = c_id
        AND Session_Type = se_type;
     END //
DELIMITER ;





--attendanse find by stid and course id ("tg/2024/0001","ICT1253")
DELIMITER //
 CREATE PROCEDURE attendance_by_stid_cid(IN st_id VARCHAR(20), IN c_id VARCHAR(20))
     BEGIN
     SELECT Session_Date,Week_Number,Session_Type,Status FROM attendance WHERE ST_Id = st_id AND
     Course_code = c_id;
     END //
DELIMITER ;





--update procedure attendance ("tg/2024/0001","ICT1253",15,"t","a")
 CREATE PROCEDURE update_attendance(
         IN in_ST_Id VARCHAR(50),
         IN in_Course_code VARCHAR(50),
         IN in_Week_Number INT,
         IN in_session_type VARCHAR(20),
         IN in_status_flag VARCHAR(5)
     )
     BEGIN
    
         DECLARE s_type VARCHAR(20);
         DECLARE new_status VARCHAR(20);
    
    
    
    
         IF in_session_type IN ('t','theory','T','Theory') THEN
             SET s_type = 'Theory';
         ELSEIF in_session_type IN ('p','practical','P','Practical') THEN
             SET s_type = 'Practical';
         ELSE
             SELECT "invalid please enter ('t','theory','T','Theory') or ('p','practical','P','Practical')" AS message;
         END IF;
    
    
    
         IF in_status_flag IN ('p','present','P','Present') THEN
             SET new_status = 'Present';
         ELSEIF in_status_flag IN ('a','absent','A','Absent') THEN
             SET new_status = 'Absent';
         ELSE
             SELECT "invalid please enter ('p','present','P','Present') or ('a','absent','A','Absent')" AS message;
         END IF;
    
    
         UPDATE attendance
         SET Status = new_status
         WHERE ST_Id = in_ST_Id
           AND Course_code = in_Course_code
           AND Week_Number = in_Week_Number
           AND Session_Type = s_type;
    
    
    
         SELECT * FROM attendance
         WHERE ST_Id = in_ST_Id
           AND Course_code = in_Course_code
           AND Week_Number = in_Week_Number
           AND Session_Type = s_type;
     END//


DELIMITER ;






--attendance summery by course id ("ICT1222")
DELIMITER //
CREATE PROCEDURE attendance_summary_by_course_id(IN c_id VARCHAR(15))
BEGIN
    SELECT
        a.ST_Id,
        a.Course_code,
        COUNT(*) as Total_Sessions,
        SUM(CASE WHEN Status = 'Present' THEN 1 ELSE 0 END) as Present,
        SUM(CASE WHEN Status = 'Absent' THEN 1 ELSE 0 END) as Absent,
        ROUND((SUM(CASE WHEN Status IN ('Present') THEN 1 ELSE 0 END) / COUNT(*)) * 100, 2) as Percentage,
        CASE
            WHEN ROUND((SUM(CASE WHEN Status IN ('Present') THEN 1 ELSE 0 END) / COUNT(*)) * 100, 2) >= 80
            THEN 'Eligible'
            ELSE 'Not Eligible'
        END as Eligibility
    FROM attendance a
    WHERE a.Course_code = c_id
    GROUP BY a.ST_Id, a.Course_code;
END //
DELIMITER ;





--show attendance untill specific day by givin registation number and course code
DELIMITER //
 CREATE PROCEDURE attendance_by_stid_cid_date(IN st_id VARCHAR(20), IN c_id VARCHAR(20), IN until_date DATE)
     BEGIN
     SELECT Session_Date,Week_Number,Session_Type,Status FROM attendance WHERE ST_Id = st_id AND
     Course_code = c_id AND Session_Date <= until_date;
     END //
DELIMITER ;






--show attendance untill specific day by givin registation number , course code and session type
drop procedure if exists attendance_by_stid_cid_seperate_type_date;
DELIMITER //
CREATE PROCEDURE attendance_by_stid_cid_seperate_type_date(
      IN st_id VARCHAR(20),
      IN c_id VARCHAR(20),
      IN s_type VARCHAR(2),
      IN until_date DATE
     )
     BEGIN
    
      DECLARE se_type VARCHAR(20);
    
      IF s_type IN ('t','T') THEN
              SET se_type = 'Theory';
      ELSEIF s_type IN ('p','P') THEN
              SET se_type = 'Practical';
      ELSE
              SELECT 'Invalid input please enter (\'t\',\'T\') or (\'p\',\'P\')' AS MESSAGE;
    
      END IF;
    
      SELECT Session_Date, Week_Number, Session_Type, Status
      FROM attendance
      WHERE ST_Id = st_id
        AND Course_code = c_id
        AND Session_Type = se_type
        AND Session_Date <= until_date;
     END //
DELIMITER ;
///////////////////////////////////////////////////////////////////////////////
end Tharupama
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
