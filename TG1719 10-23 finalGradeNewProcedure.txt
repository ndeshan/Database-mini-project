UPDATE student_result
SET Final_Grade=NULL;

DELIMITER //

CREATE PROCEDURE calculateFinalMark()


BEGIN 

DECLARE get_ca_marks DECIMAL(5,2);
DECLARE get_theory_marks DECIMAL(5,2);
DECLARE get_practical_marks DECIMAL(5,2);
DECLARE get_type ENUM('Theory','Practical','Both');
DECLARE done BOOLEAN DEFAULT FALSE;
DECLARE get_course_id CHAR(15);
DECLARE get_student_id CHAR(15);
DECLARE get_Eligibility CHAR(15);
DECLARE grade CHAR(15);
DECLARE get_Final_grade CHAR(15);
DECLARE final_marks_60 DECIMAL(5,2);
DECLARE Final_marks DECIMAL(5,2);
DECLARE get_Confirmation CHAR(20);

DECLARE cursor01 CURSOR FOR 

SELECT  s.CA_Marks,m.Final_Theory,m.Final_Practical ,m.Type,m.course_code,m.student_id,
a.Eligibility ,s.Final_Grade,c.Official_Confirmation
FROM  student_result s
INNER JOIN  mark m ON m.student_id=s.student_id 
AND s.course_code =m.course_code 

INNER JOIN course_enrollment c ON c.ST_Id=s.student_id AND c.Course_code=s.course_code

LEFT JOIN attendance_summary a ON a.ST_Id=s.student_id AND
 a.Course_code= s.course_code ;

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=TRUE;


OPEN cursor01;

read_loop:LOOP

FETCH cursor01 INTO get_ca_marks,get_theory_marks,get_practical_marks,get_type,
get_course_id, get_student_id,get_Eligibility,get_Final_grade,get_Confirmation;

IF done THEN
	LEAVE read_loop;
END IF;

IF get_Eligibility='Eligible' THEN 

	IF get_type='Theory' THEN
		SET final_marks_60=(get_theory_marks/100)*60;
	ELSEIF get_type='Practical' THEN
		SET final_marks_60=(get_practical_marks/100)*60;
	ELSEIF get_type='Both' THEN
		SET final_marks_60=((get_practical_marks+get_theory_marks)/200)*60;
	
	END IF;
ELSE 
SET final_marks_60=0;	
END IF;
	
	SET Final_marks=final_marks_60+get_ca_marks;
UPDATE student_result 
SET Final_Marks=Final_marks
WHERE student_id=get_student_id AND course_code=get_course_id;
	IF (get_Confirmation='REPEAT') THEN
			IF (Final_marks>=45)THEN
					SET grade='C';
			ELSEIF(Final_marks>=40)THEN
					SET grade='C-';
			ELSEIF(Final_marks>=35)THEN
					SET grade='D';
			ELSE
					SET grade='E';	
		END IF;
	ELSEIF (get_ca_marks <16 AND final_marks_60 < 25)THEN 
		SET grade='E(CA&ESA)';
	ELSEIF get_ca_marks <16 THEN
		SET grade='E(CA)';
	ELSEIF final_marks_60<25 THEN
		SET grade='E(ESA)';
	
	ELSEIF  (Final_marks<=100 AND  Final_marks>=85) THEN
		SET grade='A+';
	
	ELSEIF  ( Final_marks>=75) THEN
		SET grade='A';
	ELSEIF  ( Final_marks>=70) THEN
		SET grade='A-';
	ELSEIF  ( Final_marks>=65) THEN
		SET grade='B+';
	ELSEIF  ( Final_marks>=60) THEN
		SET grade='B';
	ELSEIF  ( Final_marks>=55) THEN
		SET grade='B-';
	ELSEIF  ( Final_marks>=50) THEN
		SET grade='C+';
	ELSEIF  ( Final_marks>=45) THEN
		SET grade='C';
	ELSEIF  ( Final_marks>=40) THEN
		SET grade='C-';
	ELSEIF  ( Final_marks>=35) THEN
		SET grade='D';
	ELSEIF  ( Final_marks>=0) THEN
		SET grade='E';
END IF;
	

	UPDATE  student_result
	SET Final_Grade=grade
	WHERE student_id=get_student_id AND course_code =get_course_id;

IF( grade ='E' OR grade= 'D' OR grade='C-' OR grade='E(CA&ESA)' OR grade='E(CA)' OR grade='E(ESA)') THEN
		
	UPDATE  student_result
	SET  Result_Status='REPEAT'
	WHERE student_id=get_student_id AND course_code =get_course_id;

	END IF;
END LOOP;

CLOSE cursor01;
 
	
END//

DELIMITER ;

CALL calculateFinalMark();
